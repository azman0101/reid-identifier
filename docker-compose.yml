services:
  mosquitto:
    image: eclipse-mosquitto:2.1.2-alpine
    container_name: mosquitto
    ports:
      - "1883:1883"
    restart: unless-stopped

  # frigate:
  #   image: ghcr.io/blakeblackshear/frigate:stable
  #   container_name: frigate
  #   privileged: true
  #   restart: unless-stopped
  #   shm_size: "64mb"
  #   depends_on:
  #     - mosquitto
  #   ports:
  #     - "5000:5000"
  #     - "8971:8971"
  #     - "8554:8554"
  #     - "8555:8555/tcp"
  #     - "8555:8555/udp"
  #   volumes:
  #     - ./frigate-config:/config
  #     - ./frigate-media:/media/frigate
  #     - type: tmpfs
  #       target: /tmp/cache
  #       tmpfs:
  #         size: 1000000000
  #   environment:
  #     - FRIGATE_RTSP_PASSWORD=password

  reid-identifier:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: reid-identifier
    privileged: true
    restart: unless-stopped
    depends_on:
      - mosquitto
    ports:
      - "${REID_PORT:-8002}:8002"
    volumes:
      - ./models:/models
      - ./models/gallery:/models/gallery
      - ./models/unknown:/models/unknown
      # Mount code for dev if needed
      # - .:/app
    devices:
      - /dev/dri/renderD128
    environment:
      - MQTT_BROKER=${MQTT_BROKER:-mosquitto}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - FRIGATE_URL=${FRIGATE_URL:-http://frigate:5000}
      - DEVICE_NAME=${DEVICE_NAME:-GPU}
      - REID_PORT=${REID_PORT}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${REID_PORT}/"]
      interval: 30s
      timeout: 10s
      retries: 3
