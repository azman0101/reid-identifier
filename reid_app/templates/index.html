<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8">
    <title>Frigate ReID - Backoffice</title>
    <link href="/static/output.css" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white p-8">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
        <h1 class="text-4xl font-bold text-blue-400">Classification des Silhouettes</h1>
        <div class="flex gap-4">
            <a href="/visualization"
                class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded border border-purple-500 shadow transition font-semibold text-sm">üìä
                t-SNE</a>
            <a href="/visualization_umap"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded border border-indigo-500 shadow transition font-semibold text-sm">üìä
                UMAP</a>
            <a href="/db_viewer"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 shadow transition font-semibold text-sm">üóÑÔ∏è
                Voir Base de Donn√©es</a>
            <a href="/inspection"
                class="px-4 py-2 bg-blue-700 hover:bg-blue-600 rounded border border-blue-600 shadow transition font-semibold text-sm">üïµÔ∏è
                Inspection Historique</a>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-6 flex gap-4 border-b border-gray-700 pb-2">
        <button id="tabUnknownsBtn" onclick="switchTab('unknowns')"
            class="text-xl font-bold pb-2 text-blue-400 border-b-2 border-blue-400 transition-colors">Nouvelles
            d√©tections (√Ä nommer)</button>
        <button id="tabGalleryBtn" onclick="switchTab('gallery')"
            class="text-xl font-bold pb-2 text-gray-400 hover:text-gray-200 transition-colors">Galerie d'apprentissage
            (D√©j√† nomm√©es)</button>
    </div>

    <!-- Tab: Unknowns -->
    <div id="tabUnknowns">
        <div id="unknownsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 mb-12">
            <!-- JS virtualized -->
        </div>
        <div id="unknownsEmpty" class="hidden text-gray-400 col-span-full text-center py-4">Aucune nouvelle silhouette
            d√©tect√©e.</div>
    </div>

    <!-- Tab: Gallery -->
    <div id="tabGallery" class="hidden">
        <!-- Filters -->
        <div class="flex gap-4 mb-6 bg-gray-800 p-3 rounded border border-gray-700 sticky top-0 z-20 shadow-lg">
            <input type="text" id="filterLabel" placeholder="Filtrer Label"
                class="bg-gray-700 text-white rounded px-2 py-1 text-sm outline-none flex-1 focus:ring-2 focus:ring-blue-500"
                oninput="renderGalleryGrid()">
            <input type="text" id="filterCamera" placeholder="Filtrer Cam√©ra"
                class="bg-gray-700 text-white rounded px-2 py-1 text-sm outline-none flex-1 focus:ring-2 focus:ring-blue-500"
                oninput="renderGalleryGrid()">
            <input type="text" id="filterDate" placeholder="Filtrer Date (YYYY-MM-DD)"
                class="bg-gray-700 text-white rounded px-2 py-1 text-sm outline-none flex-1 focus:ring-2 focus:ring-blue-500"
                oninput="renderGalleryGrid()">
        </div>
        <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 mb-12">
            <!-- JS virtualized -->
        </div>
        <div id="galleryEmpty" class="hidden text-gray-400 col-span-full text-center py-4">La galerie est vide (ou aucun
            r√©sultat).</div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="zoomModal"
        class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 cursor-zoom-out"
        onclick="closeZoomModal()">
        <img id="zoomImage" src=""
            class="max-w-full max-h-full object-contain rounded-lg shadow-2xl scale-95 transition-transform duration-200">
        <button
            class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 font-bold focus:outline-none">&times;</button>
    </div>

    <script>
        const unknownsData = {{ unknowns | tojson | safe }};
        const galleryData = {{ gallery | tojson | safe }};

        let activeTab = 'unknowns';
        let galleryRendered = false;

        function switchTab(tabId) {
            activeTab = tabId;
            if (tabId === 'unknowns') {
                document.getElementById('tabUnknowns').classList.remove('hidden');
                document.getElementById('tabGallery').classList.add('hidden');
                document.getElementById('tabUnknownsBtn').className = "text-xl font-bold pb-2 text-blue-400 border-b-2 border-blue-400 transition-colors";
                document.getElementById('tabGalleryBtn').className = "text-xl font-bold pb-2 text-gray-400 hover:text-gray-200 transition-colors cursor-pointer";
            } else {
                document.getElementById('tabGallery').classList.remove('hidden');
                document.getElementById('tabUnknowns').classList.add('hidden');
                document.getElementById('tabGalleryBtn').className = "text-xl font-bold pb-2 text-blue-400 border-b-2 border-blue-400 transition-colors";
                document.getElementById('tabUnknownsBtn').className = "text-xl font-bold pb-2 text-gray-400 hover:text-gray-200 transition-colors cursor-pointer";
                if (!galleryRendered) {
                    renderGalleryGrid();
                    galleryRendered = true;
                }
            }
        }

        // Intersection Observer Setup
        const observerOptions = { root: null, rootMargin: '400px', threshold: 0 };
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                const div = entry.target;
                if (entry.isIntersecting) {
                    if (!div.dataset.loaded) {
                        div.innerHTML = div.dataset.htmlContent;
                        div.dataset.loaded = 'true';
                    }
                } else {
                    if (div.dataset.loaded) {
                        div.innerHTML = '';
                        div.dataset.loaded = '';
                    }
                }
            });
        }, observerOptions);

        function escapeHtml(unsafe) {
            if (!unsafe) return "";
            return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function renderUnknownsGrid() {
            const grid = document.getElementById('unknownsGrid');
            const empty = document.getElementById('unknownsEmpty');
            grid.innerHTML = '';

            if (unknownsData.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            unknownsData.forEach(item => {
                const wrapper = document.createElement('div');
                wrapper.className = "min-h-[350px]";

                let suggestionHtml = '';
                if (item.suggestion) {
                    suggestionHtml = `
                        <button type="button"
                            onclick="useSuggestion('${escapeHtml(item.event_id)}', '${escapeHtml(item.suggestion)}', 'form_${escapeHtml(item.event_id)}')"
                            class="bg-green-600 hover:bg-green-500 w-full py-1 rounded text-sm font-semibold transition flex justify-between px-2 items-center"
                            title="Score: ${item.suggestion_score}%">
                            <span>üí° ${escapeHtml(item.suggestion)}</span>
                            <span class="text-xs opacity-80">${item.suggestion_score}%</span>
                        </button>
                    `;
                }

                let cloudHtml = item.is_local ? '' : `
                    <div class="absolute top-2 right-2 bg-blue-600/80 text-white text-xs px-2 py-1 rounded-full shadow backdrop-blur-sm z-10" title="Fetched from Frigate">‚òÅÔ∏è</div>
                `;

                wrapper.dataset.htmlContent = `
                    <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg border border-gray-700 p-3 h-full flex flex-col opacity-90 hover:opacity-100 transition">
                        <div class="relative group cursor-pointer" onclick="openZoomModal('${escapeHtml(item.img_src)}')">
                            <img src="${escapeHtml(item.img_src)}" class="w-full h-48 object-cover rounded mb-3" loading="lazy"
                                onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'300\\' height=\\'400\\'><rect width=\\'300\\' height=\\'400\\' fill=\\'%23374151\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' fill=\\'%239CA3AF\\' font-family=\\'sans-serif\\' font-size=\\'16\\'>Introuvable</text></svg>';">
                            ${cloudHtml}
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition flex items-center justify-center rounded mb-3">
                                <span class="text-white opacity-0 group-hover:opacity-100 text-3xl drop-shadow-lg">üîç</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mb-2 flex-grow">
                            <p>üì∏ ${escapeHtml(item.camera)}</p>
                            <p>üïí ${escapeHtml(item.timestamp)}</p>
                        </div>
                        <form id="form_${escapeHtml(item.event_id)}" onsubmit="submitForm(event, '/label')" class="flex flex-col gap-2 mt-auto">
                            <input type="hidden" name="filename" value="${escapeHtml(item.filename)}">
                            <input type="hidden" name="source" value="unknown">
                            ${suggestionHtml}
                            <input type="text" id="new_label_${escapeHtml(item.event_id)}" name="new_label" placeholder="Nom (ex: Ma√´l)" required class="bg-gray-700 text-white text-sm rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 outline-none w-full">
                            <div class="flex gap-2">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-500 w-full py-1 rounded text-sm font-bold transition">Valider</button>
                                <button type="button" onclick="deleteImg('${escapeHtml(item.filename)}', 'unknown')" class="bg-red-600 hover:bg-red-500 px-2 rounded transition" title="Supprimer">‚úï</button>
                            </div>
                        </form>
                    </div>
                `;
                grid.appendChild(wrapper);
                observer.observe(wrapper);
            });
        }

        let debounceTimer;
        function renderGalleryGrid() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const grid = document.getElementById('galleryGrid');
                const empty = document.getElementById('galleryEmpty');

                Array.from(grid.children).forEach(child => observer.unobserve(child));
                grid.innerHTML = '';

                const filterLabel = document.getElementById('filterLabel').value.toLowerCase();
                const filterCamera = document.getElementById('filterCamera').value.toLowerCase();
                const filterDate = document.getElementById('filterDate').value.toLowerCase();

                const filtered = galleryData.filter(item => {
                    if (filterLabel && !item.label.toLowerCase().includes(filterLabel)) return false;
                    if (filterCamera && item.camera && !item.camera.toLowerCase().includes(filterCamera)) return false;
                    if (filterDate && item.timestamp && !item.timestamp.toLowerCase().includes(filterDate)) return false;
                    return true;
                });

                if (filtered.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                empty.classList.add('hidden');

                filtered.forEach(item => {
                    const wrapper = document.createElement('div');
                    wrapper.className = "min-h-[350px]";

                    let cameraHtml = item.camera && item.camera !== "-" ? `<p>üì∏ ${escapeHtml(item.camera)}</p>` : '';

                    wrapper.dataset.htmlContent = `
                    <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg border border-gray-700 p-3 opacity-90 hover:opacity-100 transition h-full flex flex-col">
                        <div class="relative group cursor-pointer" onclick="openZoomModal('/gallery_imgs/${escapeHtml(item.filename)}')">
                            <img src="/gallery_imgs/${escapeHtml(item.filename)}" class="w-full h-48 object-cover rounded mb-3" loading="lazy">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition flex items-center justify-center rounded mb-3">
                                <span class="text-white opacity-0 group-hover:opacity-100 text-3xl drop-shadow-lg">üîç</span>
                            </div>
                        </div>
                        <p class="text-center font-bold text-green-400 mb-1 truncate" title="${escapeHtml(item.label)}">${escapeHtml(item.label)}</p>
                        <div class="text-xs text-gray-400 mb-2 text-center flex-grow flex flex-col justify-center">
                            ${cameraHtml}
                            <p>üïí ${escapeHtml(item.timestamp)}</p>
                        </div>
                        <form id="form_${escapeHtml(item.filename)}" onsubmit="submitForm(event, '/label')" class="flex flex-col gap-2 mt-auto">
                            <input type="hidden" name="filename" value="${escapeHtml(item.filename)}">
                            <input type="hidden" name="source" value="gallery">
                            <input type="text" name="new_label" placeholder="Corriger..." required class="bg-gray-700 text-white text-sm rounded px-2 py-1 focus:ring-2 focus:ring-yellow-500 outline-none w-full">
                            <select name="update_type" class="bg-gray-700 text-white text-xs rounded px-2 py-1 outline-none w-full border border-gray-600">
                                <option value="image">Cette image seule</option>
                                <option value="identity">Toute l'identit√©</option>
                            </select>
                            <div class="flex gap-2">
                                <button type="submit" class="bg-yellow-600 hover:bg-yellow-500 w-full py-1 rounded text-sm font-bold transition">Modifier</button>
                                <button type="button" onclick="deleteImg('${escapeHtml(item.filename)}', 'gallery')" class="bg-red-600 hover:bg-red-500 px-2 rounded transition" title="Supprimer">‚úï</button>
                            </div>
                        </form>
                    </div>
                    `;
                    grid.appendChild(wrapper);
                    observer.observe(wrapper);
                });
            }, 100);
        }

        async function submitForm(e, endpoint) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Wait...";

            try {
                const formData = new FormData(e.target);
                const response = await fetch(endpoint, { method: 'POST', body: formData });
                const result = await response.json();

                if (result.status === 'success') {
                    window.location.reload();
                } else {
                    alert("Erreur: " + result.message);
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            } catch (err) {
                console.error(err);
                alert("Erreur r√©seau");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function useSuggestion(eventId, suggestionText, formId) {
            const input = document.getElementById('new_label_' + eventId);
            if (input) {
                input.value = suggestionText;
                const form = document.getElementById(formId);
                const btn = form.querySelector('button[type="submit"]');
                if (btn) btn.click();
            }
        }

        async function deleteImg(filename, source) {
            if (confirm("Supprimer cette image d√©finitivement ?")) {
                try {
                    const formData = new FormData();
                    formData.append('filename', filename);
                    formData.append('source', source);
                    const response = await fetch('/delete', { method: 'POST', body: formData });
                    const result = await response.json();

                    if (result.status === 'deleted') {
                        window.location.reload();
                    } else {
                        alert("Erreur suppression: " + result.message);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Erreur r√©seau lors de la suppression");
                }
            }
        }

        function openZoomModal(imageSrc) {
            const modal = document.getElementById('zoomModal');
            const zoomImg = document.getElementById('zoomImage');
            zoomImg.src = imageSrc;
            modal.classList.remove('hidden');
            setTimeout(() => {
                zoomImg.classList.remove('scale-95');
                zoomImg.classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeZoomModal() {
            const modal = document.getElementById('zoomModal');
            const zoomImg = document.getElementById('zoomImage');
            zoomImg.classList.remove('scale-100');
            zoomImg.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                zoomImg.src = '';
                document.body.style.overflow = 'auto';
            }, 200);
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === "Escape") {
                closeZoomModal();
            }
        });

        // Initialize view
        renderUnknownsGrid();
    </script>
    <footer class="mt-12 pt-4 border-t border-gray-700 text-center text-xs text-gray-500">
        <p>Frigate ReID | Build: {{ version.build_date }} | Commit: <a
                href="https://github.com/azman0101/reid-identifier/commit/{{ version.git_sha }}"
                class="text-blue-400 hover:underline" target="_blank">{{ version.git_sha[:7] }}</a></p>
    </footer>
</body>

</html>
